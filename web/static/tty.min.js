(function(){var d=this.document,v=this,p,b,g,o;var j=d.title;var e=Terminal.EventEmitter,i=Terminal.inherits,n=Terminal.on,m=Terminal.off,c=Terminal.cancel;var u=new e;u.socket;u.windows;u.terms;u.elements;var k=false;d.addEventListener("visibilitychange",function(){k=d.hidden;if(!k){r()}},false);var a=function(z){var x=0;for(var y in z){x++}return x};v.onbeforeunload=function(){if(a(u.terms)!=0){return true}};u.open=function(){if(d.location.pathname){var y=d.location.pathname.split("/"),x=y.slice(0,y.length-1).join("/")+"/",z=x.substring(1)+"socket.io";u.socket=io.connect(null,{resource:z})}else{u.socket=io.connect()}u.windows=[];u.terms={};u.elements={root:d.documentElement,body:d.body,h1:d.getElementsByTagName("h1")[0],open:d.getElementById("open")};p=u.elements.root;b=u.elements.body;g=u.elements.h1;o=u.elements.open;if(o){n(o,"click",function(){new w})}u.socket.on("connect",function(){u.reset();u.emit("connect")});u.socket.on("data",function(B,A){if(!u.terms[B]){return}u.terms[B].write(A)});u.socket.on("kill",function(A){if(!u.terms[A]){return}u.terms[A]._destroy()});u.socket.on("sync",function(B){u.reset();var A=u.socket.emit;u.socket.emit=function(){};Object.keys(B).forEach(function(D){var C=B[D],F=new w,E=F.tabs[0];delete u.terms[E.id];E.pty=C.pty;E.id=C.id;u.terms[C.id]=E;F.resize(C.cols,C.rows);u.emit("open tab",E);E.emit("open")});u.socket.emit=A});setInterval(function(){var A=u.windows.length;while(A--){if(!u.windows[A].focused){continue}u.windows[A].focused.pollProcessName()}},2*1000);u.emit("load");u.emit("open")};u.reset=function(){var x=u.windows.length;while(x--){u.windows[x].destroy()}u.windows=[];u.terms={};u.emit("reset")};var r=(function(){var x;return function(y){d.title=(k?"*":"")+(u.windows.length?("["+(u.windows.length)+"]"):"")+(y||x);x=y||x}})();function w(F){var D=this;e.call(this);var A,B,x,y,H,G,E,z;A=d.createElement("div");A.className="terminal-content";z=d.createElement("div");z.className="window";B=d.createElement("div");B.className="grip";x=d.createElement("div");x.className="bar";y=d.createElement("span");y.innerHTML='<i class="iconfont icon-guanbi2" >';y.title="Close";y.className="tab close";H=d.createElement("span");H.className="tab title";H.innerHTML="";G=d.createElement("div");G.className="statusbar";E=d.createElement("span");E.className="tab size";E.innerHTML="";this.socket=F||u.socket;this.element=A;this.content=z;this.grip=B;this.bar=x;this.btnClose=y;this.title=H;this.statusbar=G;this.size=E;this.tabs=[];this.focused=null;this.cols=Terminal.geometry[0];this.rows=Terminal.geometry[1];A.appendChild(B);x.appendChild(y);x.appendChild(H);G.appendChild(E);z.appendChild(x);z.appendChild(A);z.appendChild(G);var C=d.querySelector("#main");C.appendChild(z);u.windows.push(this);this.createTab();this.focus();this.bind();this.tabs[0].once("open",function(){D.resize(D.cols,D.rows);u.emit("open window",D);D.emit("open")})}i(w,e);w.prototype.bind=function(){var C=this,A=this.element,z=this.content,x=this.bar,B=this.grip,y=this.btnClose;n(y,"click",function(D){C.destroy();return c(D)});n(B,"mousedown",function(D){C.focus();C.resizing(D);return c(D)});n(z,"mousedown",function(D){if(D.target!==A&&D.target!==x){return}C.focus();c(D);C.drag(D);return c(D)})};w.prototype.focus=function(){var x=this.content;var y=x.parentNode;if(y){y.removeChild(x);y.appendChild(x)}this.focused.focus();this.focused.handleTitle(this.focused.title);u.emit("focus window",this);this.emit("focus")};w.prototype.destroy=function(){if(this.destroyed){return}this.destroyed=true;s(u.windows,this);if(u.windows.length){u.windows[0].focus()}this.content.parentNode.removeChild(this.content);this.each(function(x){x.destroy()});r(u.windows.focused?u.window.focused.title:j);u.emit("close window",this);this.emit("close")};var f=function(y,x){var z={x:{min:0,max:x.clientWidth},y:{min:0,max:x.clientHeight}};return z};w.prototype.drag=function(z){var D=this,x=this.content;var y={left:x.offsetLeft,top:x.offsetTop,pageX:z.pageX,pageY:z.pageY};var F=x.clientWidth,A=x.clientHeight;var C=f(x,b);function B(G){var H=(y.left+G.pageX-y.pageX);var I=(y.top+G.pageY-y.pageY);H=Math.max(Math.min(H,C.x.max-F),C.x.min);I=Math.max(Math.min(I,C.y.max-A),C.y.min);x.style.left=H+"px";x.style.top=I+"px"}function E(){m(d,"mousemove",B);m(d,"mouseup",E);var G={left:x.style.left.replace(/\w+/g,""),top:x.style.top.replace(/\w+/g,"")};u.emit("drag window",D,G);D.emit("drag",G)}n(d,"mousemove",B);n(d,"mouseup",E)};w.prototype.resizing=function(y){var C=this,x=this.element,E=this.focused;var z={cols:60,rows:15};var B={w:E.element.clientWidth,h:E.element.clientHeight};var D={x:y.pageX,y:y.pageY,w:E.element.clientWidth,h:E.element.clientHeight};p.style.cursor="se-resize";function A(H){var L=(D.w+H.pageX-D.x)/B.w;var M=(D.h+H.pageY-D.y)/B.h;var G=((L*E.cols)|0);var J=((M*E.rows)|0);var G=Math.max(G,z.cols);var J=Math.max(J,z.rows);var K=(G/E.cols)*B.w;var I=(J/E.rows)*B.h;x.style.width=K+"px";x.style.height=I+"px";C.setSize(G,J)}function F(H){var J=(D.w+H.pageX-D.x)/B.w;var K=(D.h+H.pageY-D.y)/B.h;var G=((J*E.cols)|0);var I=((K*E.rows)|0);var G=Math.max(G,z.cols);var I=Math.max(I,z.rows);C.resize(G,I);C.setSize(G,I);x.style.width="";x.style.height="";p.style.cursor="";m(d,"mousemove",A);m(d,"mouseup",F)}n(d,"mousemove",A);n(d,"mouseup",F)};w.prototype.setSize=function(x,y){var z=this.size;z.innerHTML=x+"×"+y};w.prototype.resize=function(x,y){this.cols=x;this.rows=y;this.each(function(z){z.resize(x,y)});this.setSize(x,y);u.emit("resize window",this,x,y);this.emit("resize",x,y)};w.prototype.each=function(x){var y=this.tabs.length;while(y--){x(this.tabs[y],y)}};w.prototype.createTab=function(){return new t(this,this.socket)};w.prototype.highlight=function(){var x=this;this.element.style.borderColor="orange";setTimeout(function(){x.element.style.borderColor=""},200);this.focus()};w.prototype.focusTab=function(z){var A=this.tabs,x=h(A,this.focused),y=A.length;if(!z){if(A[--x]){return A[x].focus()}if(A[--y]){return A[y].focus()}}else{if(A[++x]){return A[x].focus()}if(A[0]){return A[0].focus()}}return this.focused&&this.focused.focus()};w.prototype.nextTab=function(){return this.focusTab(true)};w.prototype.previousTab=function(){return this.focusTab(false)};function t(C,B){var A=this;var y=C.cols,z=C.rows;Terminal.call(this,{cols:y,rows:z});var x=d.createElement("div");x.className="tab switch-tab";x.innerHTML='<i class="iconfont icon-danxuan" >';C.bar.appendChild(x);n(x,"click",function(D){A.focus();return c(D)});this.id="";this.socket=B||u.socket;this.window=C;this.btnClose=x;this.element=null;this.process="";this.open();this.hookKeys();C.tabs.push(this);this.socket.emit("create",y,z,function(E,D){if(E){return A._destroy()}A.pty=D.pty;A.id=D.id;u.terms[A.id]=A;u.emit("open tab",A);A.emit("open")})}i(t,Terminal);t.prototype.handler=function(x){this.socket.emit("data",this.id,x)};t.prototype.handleTitle=function(x){if(!x){return}x=q(x);this.title=x;if(Terminal.focus===this){r(x)}if(this.window.focused===this){this.window.bar.title=x;this.window.title.innerHTML=x}};t.prototype._write=t.prototype.write;t.prototype.write=function(x){if(k){r()}return this._write(x)};t.prototype._focus=t.prototype.focus;t.prototype.focus=function(){if(Terminal.focus===this){return}var x=this.window;if(x.focused!==this){if(x.focused){if(x.focused.element.parentNode){x.focused.element.parentNode.removeChild(x.focused.element)}x.focused.btnClose.style.fontWeight=""}x.element.appendChild(this.element);x.focused=this;this.handleTitle(this.title||j)}this.handleTitle(this.title);this._focus();x.focus();u.emit("focus tab",this);this.emit("focus")};t.prototype._resize=t.prototype.resize;t.prototype.resize=function(x,y){this.socket.emit("resize",this.id,x,y);this._resize(x,y);u.emit("resize tab",this,x,y);this.emit("resize",x,y)};t.prototype.__destroy=t.prototype.destroy;t.prototype._destroy=function(){if(this.destroyed){return}this.destroyed=true;var x=this.window;this.btnClose.parentNode.removeChild(this.btnClose);if(this.element.parentNode){this.element.parentNode.removeChild(this.element)}if(u.terms[this.id]){delete u.terms[this.id]}s(x.tabs,this);if(x.focused===this){x.previousTab()}if(!x.tabs.length){x.destroy()}this.__destroy()};t.prototype.destroy=function(){if(this.destroyed){return}this.socket.emit("kill",this.id);this._destroy();u.emit("close tab",this);this.emit("close")};t.prototype.hookKeys=function(){var x=this;this.on("key",function(A,y){if(Terminal.focusKeys===false){return}var B,z;if(A==="\x1bj"){B=-1}else{if(A==="\x1bk"){B=+1}else{return}}z=h(u.windows,this.window)+B;this._ignoreNext();if(u.windows[z]){return u.windows[z].highlight()}if(B>0){if(u.windows[0]){return u.windows[0].highlight()}}else{z=u.windows.length-1;if(u.windows[z]){return u.windows[z].highlight()}}return this.window.highlight()});this.on("request paste",function(y){this.socket.emit("request paste",function(z,A){if(z){return}x.send(A)})});this.on("request create",function(){this.window.createTab()});this.on("request term",function(y){if(this.window.tabs[y]){this.window.tabs[y].focus()}});this.on("request term next",function(y){this.window.nextTab()});this.on("request term previous",function(y){this.window.previousTab()})};t.prototype._ignoreNext=function(){var x=this.handler;this.handler=function(){this.handler=x};var y=this.showCursor;this.showCursor=function(){this.showCursor=y}};t.scrollable={irssi:true,man:true,less:true,htop:true,top:true,w3m:true,lynx:true,mocp:true};t.prototype._bindMouse=t.prototype.bindMouse;t.prototype.bindMouse=function(){if(!Terminal.programFeatures){return this._bindMouse()}var x=this;var y="onmousewheel" in v?"mousewheel":"DOMMouseScroll";n(x.element,y,function(z){if(x.mouseEvents){return}if(!t.scrollable[x.process]){return}if((z.type==="mousewheel"&&z.wheelDeltaY>0)||(z.type==="DOMMouseScroll"&&z.detail<0)){x.keyDown({keyCode:33})}else{x.keyDown({keyCode:34})}return c(z)});return this._bindMouse()};t.prototype.pollProcessName=function(x){var y=this;this.socket.emit("process",this.id,function(z,A){if(z){return x&&x(z)}return x&&x(null,A)})};t.prototype.setProcessName=function(x){x=q(x);if(this.process!==x){this.emit("process",x)}this.process=x;this.btnClose.title=x;if(this.window.focused===this){this.window.title.innerHTML=x}};function h(z,x){var y=z.length;while(y--){if(z[y]===x){return y}}return -1}function s(z,x){var y=h(z,x);if(~y){z.splice(y,1)}}function q(x){if(!x){return""}return(x+"").replace(/[&<>]/g,"")}function l(){if(l.done){return}l.done=true;m(d,"load",l);m(d,"DOMContentLoaded",l);u.open()}n(d,"load",l);n(d,"DOMContentLoaded",l);setTimeout(l,200);u.Window=w;u.Tab=t;u.Terminal=Terminal;this.tty=u}).call(function(){return this||(typeof window!=="undefined"?window:global)}());