(function(){var d=this.document,u=this,o,b,g,n;var j=d.title;var e=Terminal.EventEmitter,i=Terminal.inherits,m=Terminal.on,l=Terminal.off,c=Terminal.cancel;var t=new e;t.socket;t.windows;t.terms;t.elements;var a=function(y){var w=0;for(var x in y){w++}return w};u.onbeforeunload=function(){if(a(t.terms)!=0){return true}};t.open=function(){if(d.location.pathname){var x=d.location.pathname.split("/"),w=x.slice(0,x.length-1).join("/")+"/",y=w.substring(1)+"socket.io";t.socket=io.connect(null,{resource:y})}else{t.socket=io.connect()}t.windows=[];t.terms={};t.elements={root:d.documentElement,body:d.body,h1:d.getElementsByTagName("h1")[0],open:d.getElementById("open")};o=t.elements.root;b=t.elements.body;g=t.elements.h1;n=t.elements.open;if(n){m(n,"click",function(){new v})}t.socket.on("connect",function(){t.reset();t.emit("connect")});t.socket.on("data",function(A,z){if(!t.terms[A]){return}t.terms[A].write(z)});t.socket.on("kill",function(z){if(!t.terms[z]){return}t.terms[z]._destroy()});t.socket.on("sync",function(A){t.reset();var z=t.socket.emit;t.socket.emit=function(){};Object.keys(A).forEach(function(C){var B=A[C],E=new v,D=E.tabs[0];delete t.terms[D.id];D.pty=B.pty;D.id=B.id;t.terms[B.id]=D;E.resize(B.cols,B.rows);t.emit("open tab",D);D.emit("open")});t.socket.emit=z});setInterval(function(){var z=t.windows.length;while(z--){if(!t.windows[z].focused){continue}t.windows[z].focused.pollProcessName()}},2*1000);t.emit("load");t.emit("open")};t.reset=function(){var w=t.windows.length;while(w--){t.windows[w].destroy()}t.windows=[];t.terms={};t.emit("reset")};var q=function(w){d.title=(t.windows.length?("["+(t.windows.length)+"]"):"")+w};function v(E){var C=this;e.call(this);var z,A,w,x,G,F,D,y;z=d.createElement("div");z.className="terminal-content";y=d.createElement("div");y.className="window";A=d.createElement("div");A.className="grip";w=d.createElement("div");w.className="bar";x=d.createElement("span");x.innerHTML='<i class="iconfont icon-guanbi2" >';x.title="Close";x.className="tab close";G=d.createElement("span");G.className="tab title";G.innerHTML="";F=d.createElement("div");F.className="statusbar";D=d.createElement("span");D.className="tab size";D.innerHTML="";this.socket=E||t.socket;this.element=z;this.content=y;this.grip=A;this.bar=w;this.btnClose=x;this.title=G;this.statusbar=F;this.size=D;this.tabs=[];this.focused=null;this.cols=Terminal.geometry[0];this.rows=Terminal.geometry[1];z.appendChild(A);w.appendChild(x);w.appendChild(G);F.appendChild(D);y.appendChild(w);y.appendChild(z);y.appendChild(F);var B=d.querySelector("#main");B.appendChild(y);t.windows.push(this);this.createTab();this.focus();this.bind();this.tabs[0].once("open",function(){C.resize(C.cols,C.rows);t.emit("open window",C);C.emit("open")})}i(v,e);v.prototype.bind=function(){var B=this,z=this.element,y=this.content,w=this.bar,A=this.grip,x=this.btnClose;m(x,"click",function(C){B.destroy();return c(C)});m(A,"mousedown",function(C){B.focus();B.resizing(C);return c(C)});m(y,"mousedown",function(C){if(C.target!==z&&C.target!==w){return}B.focus();c(C);B.drag(C);return c(C)})};v.prototype.focus=function(){var w=this.content;var x=w.parentNode;if(x){x.removeChild(w);x.appendChild(w)}this.focused.focus();this.focused.handleTitle(this.focused.title);t.emit("focus window",this);this.emit("focus")};v.prototype.destroy=function(){if(this.destroyed){return}this.destroyed=true;r(t.windows,this);if(t.windows.length){t.windows[0].focus()}this.content.parentNode.removeChild(this.content);this.each(function(w){w.destroy()});q(t.windows.focused?t.window.focused.title:j);t.emit("close window",this);this.emit("close")};var f=function(x,w){var y={x:{min:0,max:w.clientWidth},y:{min:0,max:w.clientHeight}};return y};v.prototype.drag=function(z){var D=this,x=this.content;var y={left:x.offsetLeft,top:x.offsetTop,pageX:z.pageX,pageY:z.pageY};var F=x.clientWidth,A=x.clientHeight;var C=f(x,b);function B(w){var G=(y.left+w.pageX-y.pageX);var H=(y.top+w.pageY-y.pageY);G=Math.max(Math.min(G,C.x.max-F),C.x.min);H=Math.max(Math.min(H,C.y.max-A),C.y.min);x.style.left=G+"px";x.style.top=H+"px"}function E(){l(d,"mousemove",B);l(d,"mouseup",E);var w={left:x.style.left.replace(/\w+/g,""),top:x.style.top.replace(/\w+/g,"")};t.emit("drag window",D,w);D.emit("drag",w)}m(d,"mousemove",B);m(d,"mouseup",E)};v.prototype.resizing=function(x){var B=this,w=this.element,D=this.focused;var y={cols:60,rows:15};var A={w:D.element.clientWidth,h:D.element.clientHeight};var C={x:x.pageX,y:x.pageY,w:D.element.clientWidth,h:D.element.clientHeight};w.style.overflow="hidden";w.style.opacity="0.70";w.style.cursor="se-resize";o.style.cursor="se-resize";D.element.style.height="100%";function z(G){var K=(C.w+G.pageX-C.x)/A.w;var L=(C.h+G.pageY-C.y)/A.h;var F=((K*D.cols)|0);var I=((L*D.rows)|0);var F=Math.max(F,y.cols);var I=Math.max(I,y.rows);var J=(F/D.cols)*A.w;var H=(I/D.rows)*A.h;w.style.width=J+"px";w.style.height=H+"px";B.setSize(F,I)}function E(G){var I=(C.w+G.pageX-C.x)/A.w;var J=(C.h+G.pageY-C.y)/A.h;var F=((I*D.cols)|0);var H=((J*D.rows)|0);var F=Math.max(F,y.cols);var H=Math.max(H,y.rows);B.resize(F,H);B.setSize(F,H);w.style.width="";w.style.height="";w.style.overflow="";w.style.opacity="";w.style.cursor="";o.style.cursor="";D.element.style.height="";l(d,"mousemove",z);l(d,"mouseup",E)}m(d,"mousemove",z);m(d,"mouseup",E)};v.prototype.setSize=function(w,x){var y=this.size;y.innerHTML=w+"×"+x};v.prototype.resize=function(w,x){this.cols=w;this.rows=x;this.each(function(y){y.resize(w,x)});this.setSize(w,x);t.emit("resize window",this,w,x);this.emit("resize",w,x)};v.prototype.each=function(w){var x=this.tabs.length;while(x--){w(this.tabs[x],x)}};v.prototype.createTab=function(){return new s(this,this.socket)};v.prototype.highlight=function(){var w=this;this.element.style.borderColor="orange";setTimeout(function(){w.element.style.borderColor=""},200);this.focus()};v.prototype.focusTab=function(y){var z=this.tabs,w=h(z,this.focused),x=z.length;if(!y){if(z[--w]){return z[w].focus()}if(z[--x]){return z[x].focus()}}else{if(z[++w]){return z[w].focus()}if(z[0]){return z[0].focus()}}return this.focused&&this.focused.focus()};v.prototype.nextTab=function(){return this.focusTab(true)};v.prototype.previousTab=function(){return this.focusTab(false)};function s(B,A){var z=this;var x=B.cols,y=B.rows;Terminal.call(this,{cols:x,rows:y});var w=d.createElement("div");w.className="tab switch-tab";w.innerHTML='<i class="iconfont icon-danxuan" >';B.bar.appendChild(w);m(w,"click",function(C){z.focus();return c(C)});this.id="";this.socket=A||t.socket;this.window=B;this.btnClose=w;this.element=null;this.process="";this.open();this.hookKeys();B.tabs.push(this);this.socket.emit("create",x,y,function(D,C){if(D){return z._destroy()}z.pty=C.pty;z.id=C.id;t.terms[z.id]=z;t.emit("open tab",z);z.emit("open")})}i(s,Terminal);s.prototype.handler=function(w){this.socket.emit("data",this.id,w)};s.prototype.handleTitle=function(w){if(!w){return}w=p(w);this.title=w;if(Terminal.focus===this){q(w)}if(this.window.focused===this){this.window.bar.title=w;this.window.title.innerHTML=w}};s.prototype._write=s.prototype.write;s.prototype.write=function(w){if(this.window.focused!==this){this.btnClose.style.color="red"}return this._write(w)};s.prototype._focus=s.prototype.focus;s.prototype.focus=function(){if(Terminal.focus===this){return}var w=this.window;if(w.focused!==this){if(w.focused){if(w.focused.element.parentNode){w.focused.element.parentNode.removeChild(w.focused.element)}w.focused.btnClose.style.fontWeight=""}w.element.appendChild(this.element);w.focused=this;this.handleTitle(this.title||j)}this.handleTitle(this.title);this._focus();w.focus();t.emit("focus tab",this);this.emit("focus")};s.prototype._resize=s.prototype.resize;s.prototype.resize=function(w,x){this.socket.emit("resize",this.id,w,x);this._resize(w,x);t.emit("resize tab",this,w,x);this.emit("resize",w,x)};s.prototype.__destroy=s.prototype.destroy;s.prototype._destroy=function(){if(this.destroyed){return}this.destroyed=true;var w=this.window;this.btnClose.parentNode.removeChild(this.btnClose);if(this.element.parentNode){this.element.parentNode.removeChild(this.element)}if(t.terms[this.id]){delete t.terms[this.id]}r(w.tabs,this);if(w.focused===this){w.previousTab()}if(!w.tabs.length){w.destroy()}this.__destroy()};s.prototype.destroy=function(){if(this.destroyed){return}this.socket.emit("kill",this.id);this._destroy();t.emit("close tab",this);this.emit("close")};s.prototype.hookKeys=function(){var w=this;this.on("key",function(z,x){if(Terminal.focusKeys===false){return}var A,y;if(z==="\x1bj"){A=-1}else{if(z==="\x1bk"){A=+1}else{return}}y=h(t.windows,this.window)+A;this._ignoreNext();if(t.windows[y]){return t.windows[y].highlight()}if(A>0){if(t.windows[0]){return t.windows[0].highlight()}}else{y=t.windows.length-1;if(t.windows[y]){return t.windows[y].highlight()}}return this.window.highlight()});this.on("request paste",function(x){this.socket.emit("request paste",function(y,z){if(y){return}w.send(z)})});this.on("request create",function(){this.window.createTab()});this.on("request term",function(x){if(this.window.tabs[x]){this.window.tabs[x].focus()}});this.on("request term next",function(x){this.window.nextTab()});this.on("request term previous",function(x){this.window.previousTab()})};s.prototype._ignoreNext=function(){var w=this.handler;this.handler=function(){this.handler=w};var x=this.showCursor;this.showCursor=function(){this.showCursor=x}};s.scrollable={irssi:true,man:true,less:true,htop:true,top:true,w3m:true,lynx:true,mocp:true};s.prototype._bindMouse=s.prototype.bindMouse;s.prototype.bindMouse=function(){if(!Terminal.programFeatures){return this._bindMouse()}var w=this;var x="onmousewheel" in u?"mousewheel":"DOMMouseScroll";m(w.element,x,function(y){if(w.mouseEvents){return}if(!s.scrollable[w.process]){return}if((y.type==="mousewheel"&&y.wheelDeltaY>0)||(y.type==="DOMMouseScroll"&&y.detail<0)){w.keyDown({keyCode:33})}else{w.keyDown({keyCode:34})}return c(y)});return this._bindMouse()};s.prototype.pollProcessName=function(w){var x=this;this.socket.emit("process",this.id,function(y,z){if(y){return w&&w(y)}return w&&w(null,z)})};s.prototype.setProcessName=function(w){w=p(w);if(this.process!==w){this.emit("process",w)}this.process=w;this.btnClose.title=w;if(this.window.focused===this){this.window.title.innerHTML=w}};function h(y,w){var x=y.length;while(x--){if(y[x]===w){return x}}return -1}function r(y,w){var x=h(y,w);if(~x){y.splice(x,1)}}function p(w){if(!w){return""}return(w+"").replace(/[&<>]/g,"")}function k(){if(k.done){return}k.done=true;l(d,"load",k);l(d,"DOMContentLoaded",k);t.open()}m(d,"load",k);m(d,"DOMContentLoaded",k);setTimeout(k,200);t.Window=v;t.Tab=s;t.Terminal=Terminal;this.tty=t}).call(function(){return this||(typeof window!=="undefined"?window:global)}());